(function(w,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(w=typeof globalThis<"u"?globalThis:w||self,e(w.VueMultiUploader={},w.Vue))})(this,function(w,e){"use strict";/*!
 * dush <https://github.com/tunnckoCore/dush>
 *
 * Copyright (c) Charlike Mike Reagent <@tunnckoCore> (https://i.am.charlike.online)
 * Released under the MIT license.
 */function te(){var t=Object.create(null),r={_allEvents:t,use:function(s,i){var c=s(r,i);return c||r},on:function(s,i,c){var S=r._allEvents[s]||(r._allEvents[s]=[]);function E(){r.off(s,E),i.apply(i,arguments)}E.fn=i;var m=c?E:i;return S.push(m),r},once:function(s,i){return r.on(s,i,!0),r},off:function(s,i){return i&&r._allEvents[s]?r._allEvents[s]=r._allEvents[s].filter(function(c){return c!==i&&c!==i.fn}):s?r._allEvents[s]=[]:r._allEvents=Object.create(null),r},emit:function(s){if(s!=="*"){var i=[].slice.call(arguments);(r._allEvents[s]||[]).map(function(c){c.apply(c,i.slice(1))}),(r._allEvents["*"]||[]).map(function(c){c.apply(c,i)})}return r}};return r}const P={change:"onChange","delete-item":"onDeleteItem",uploading:"onUploading",uploaded:"onUploaded","create-item":"onCreateItem","item-upload-start":"onItemUploadStart","item-upload-success":"onItemUploadSuccess","item-upload-fail":"onItemUploadFail","item-upload-end":"onItemUploadEnd","item-upload-progress":"onItemUploadProgress","invalid-file":"onInvalidFile"};function O(t){const r=te();for(const n in P){const s=P[n];s&&t[s]&&r.on(n,t[s])}return r}var f=(t=>(t.PENDING="pending",t.UPLOADING="uploading",t.UPLOADED="uploaded",t.ERROR="error",t))(f||{});class ne extends Error{constructor(r,n,s){super(r),this.file=n,this.accepted=s,this.name="InvalidFileTypeError"}}class re extends Error{constructor(r,n,s){super(r),this.file=n,this.maxSize=s,this.name="InvalidFileSizeError"}}function oe(t,r){const n=document.createElement("input");n.id="multi-uploader-selector",n.type="file",n.accept=t.value,n.multiple=!0,n.style.display="none",n.addEventListener("change",()=>{const s=n.files;r(s),n.remove()}),n.addEventListener("change",()=>{n.remove()}),n.addEventListener("blur",()=>{n.remove()}),document.body.appendChild(n),n.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}))}function se(t,r,n){if(t.__dragging_events)return;let s=0;t.addEventListener("dragover",i=>{i.preventDefault()}),t.addEventListener("dragenter",i=>{i.stopPropagation(),i.preventDefault(),s++,t.classList.add(r.value)}),t.addEventListener("dragleave",i=>{i.stopPropagation(),i.preventDefault(),s--,s===0&&t.classList.remove(r.value)}),t.addEventListener("drop",async i=>{var R;i.stopPropagation(),i.preventDefault(),t.classList.remove(r.value);const c=(R=i.dataTransfer)==null?void 0:R.items,S=[],E=async p=>{const d=[];p.isDirectory?p.createReader().readEntries(N=>{N.forEach(z=>{d.push(E(z))})}):d.push(new Promise(h=>{p.file(N=>{S.push(N),h()})})),await Promise.all(d)},m=[];Array.prototype.forEach.call(c??[],p=>{const d=p.webkitGetAsEntry();d&&m.push(E(d))}),m.length&&Promise.all(m).then(()=>{n(S)})}),t.__dragging_events=!0}function A(t){var r;return t.uploadState===f.UPLOADED?t.mime?$(t.mime):B(t.url):t.mime?$(t.mime):B(((r=t.file)==null?void 0:r.name)||t.url)}function B(t){var i;const r=t.match(/^data:image\/([a-zA-Z0-9.+-]+);base64,/);let n;return r?n=r[1]:n=((i=t.split(".").pop())==null?void 0:i.split("?").shift())||"",["png","apng","jpeg","jpg","gif","bmp","webp","avif","heic","heif"].indexOf(n.toLowerCase())!==-1}function $(t){return t.startsWith("image/")}const b=class b{};b.alert=async(r,n)=>(n&&(r+=" | "+n),window.alert(r)),b.confirm=async(r,n)=>new Promise(s=>{n&&(r+=" | "+n);const i=confirm(r);s(i)}),b.deleteConfirm=async(r,n)=>b.confirm(r,n),b.notify=async(r,n,s="log")=>(n&&(r+=" | "+n),s==="error"?console.error(r):s==="warn"?console.warn(r):console.log(r),async()=>{}),b.clearNotifies=async()=>{},b.confirmText=()=>"OK",b.cancelText=()=>"Cancel",b.deleteText=()=>"Delete";let x=b;function ie(){return typeof window>"u"}function L(t="",r=!1){if(r){const s=(performance!=null&&performance.timeOrigin?Math.round(performance.timeOrigin):performance.timing.navigationStart)*1e5+performance.now()*100;return t+s.toString(12)+F(4)}return t+F(12)}function F(t=12){return!ie()&&!globalThis.crypto?String(Math.floor(Math.random()*t**10)):Array.from(ae(t)).map(r=>r.toString(16).padStart(2,"0")).join("")}function ae(t=12){const r=new Uint8Array(t);return globalThis.crypto.getRandomValues(r),r}class le{constructor(r=1){this.maxRunning=r,this.items=[],this.currentRunning=0,this.running=!1,this.observers=[]}push(r){const n=new Promise((s,i)=>{this.items.push(()=>Promise.resolve(r()).then(s))});return this.run(),n}run(){this.running||(this.running=!0),this.pop()}async pop(){const r=this.items.shift();if(!r)return this.running=!1,Promise.resolve();if(this.currentRunning>=this.maxRunning)return this.items.unshift(r),Promise.resolve();this.currentRunning++,this.notice();try{return await r()}catch(n){throw n}finally{this.endPop()}}endPop(){this.currentRunning--,this.notice(),this.pop()}clear(){return this.items=[],this.notice(),this}isEmpty(){return this.items.length===0}get length(){return this.items.length}peek(){return this.items}observe(r,n={}){return this.observers.push({handler:r,once:n.once||!1}),()=>{this.off(r)}}once(r,n={}){return n.once=!0,this.observe(r,n)}onEnd(r,n={}){return this.observe((s,i,c)=>{i===0&&c===0&&r(s,i,c)},n)}notice(){return this.observers.forEach(r=>{r.handler(this,this.length,this.currentRunning)}),this.observers=this.observers.filter(r=>!r.once),this}off(r){return r==null?(this.observers=[],this):(this.observers=this.observers.filter(n=>n.handler!==r),this)}}function ce(t=1){return new le(t)}function de(){return ce()}function ue(t){return t?"$el"in t?t.$el:t:null}function D(t,r){return t.key??(t.key=L()),t.uploadState??(t.uploadState=f.PENDING),t.progress??(t.progress=0),r&&Object.assign(t,r),t}function pe(t){return D(t)}function y(t){return typeof t=="function"&&(t=e.ref(t())),e.isRef(t)?t:e.ref(t)}function T(t,r,n={}){const s=y(n.id??"vue-multi-uploader-"+L()),i=y(n.accept??""),c=y(n.maxFiles),S=y(n.maxConcurrent??2),E=y(n.maxItemSize),m=y(n.disabled??!1),R=y(n.readonly??!1),p=y(r),d=e.computed(()=>y(n.dropzone).value),h=y(n.onDragClass??"h-ondrag"),N=y(n.autoStart??!0),z=y(n.inputName??"file"),G=y(n.headers??{}),j=y(n.data??{});let v=y(t);v.value=v.value.map(o=>D(o,{uploadState:f.UPLOADED}));const q=de(),C=O(n);e.watch(S,o=>{q.maxRunning=o},{immediate:!0});function k(o,...a){return C.emit(o,...a)}function ze(o,a){return C.on(o,a),()=>{C.off(o,a)}}function Ce(){oe(i,K)}e.watch(d,()=>{const o=ue(d.value);o&&o instanceof HTMLElement&&Ue(o)},{immediate:!0});function Ue(o){se(o,h,K)}function H(o){return X(Q(o))}function Q(o){const l=e.reactive(D({key:L(),url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",file:o,mime:o.type,uploadState:f.PENDING,progress:0}));return l.title=l.title||l.file.name,C.emit("create-item",l),l}function X(o){const a=e.reactive(D({key:L(),uploadState:f.PENDING,progress:0},o));if(!o.file)return o;if(M(o.file),E.value!=null&&o.file.size>E.value){const u=new re("File size is too large",o.file,E.value);throw k("invalid-file",u),u}const l=v.value.push(a),I=v.value[l-1];if(A(I)){const u=new FileReader;u.onload=U=>{var g;I.thumbUrl=String((g=U.target)==null?void 0:g.result)},u.readAsDataURL(o.file)}return I}function K(o){Array.prototype.forEach.call(o,M),Array.prototype.forEach.call(o,a=>{if(!W.value)return;const l=H(a);N.value&&_(l)})}function Pe(o){var a;if(o instanceof XMLHttpRequest){o.abort();return}(a=o.xhr)==null||a.abort()}function M(o){const a=J.value,l=o.name.split(".").pop();if(a.length){let I=!1;if(a.forEach(u=>{I||(u.indexOf("/")!==-1?De(u,o.type)&&(I=!0):u.toLowerCase()===(l==null?void 0:l.toLowerCase())&&(I=!0))}),!I){const u=new ne("Invalid file type",o,a);throw k("invalid-file",u),u}}}function De(o,a){const l=o.split("/"),I=a.split("/");return l[1]==="*"?l[0]===I[0]:o===a}function Ae(o){k("delete-item",o),v.value=v.value.filter(a=>a.key!==o.key)}async function Be(){const o=[];return v.value.forEach(a=>{a.uploadState===f.PENDING&&o.push(_(a))}),Promise.allSettled(o)}async function _(o){return q.push(()=>Y(o))}async function Y(o){o.uploadState=f.UPLOADING,o.error=void 0;const a=new FormData;for(const u in j.value)a.append(u,j.value[u]);a.append(z.value,o.file);let l=new XMLHttpRequest;l.open("POST",p.value);for(const u in G.value)l.setRequestHeader(u,G.value[u]);return n.prepareXhr&&(l=await n.prepareXhr(l)??l),new Promise((u,U)=>{k("item-upload-start",o,l,a),l.upload.onprogress=g=>{g.lengthComputable&&(o.progress=g.loaded/g.total,k("item-upload-progress",o,g))},l.onload=()=>{if(l.status>=200&&l.status<300)try{o.uploadState=f.UPLOADED,k("item-upload-success",o,l),u(o)}catch(g){console.error(g),o.uploadState=f.ERROR,o.error=g,U(g)}else{const g=`Upload failed with status: ${l.status}`,V=new Error(g);console.error(V),o.uploadState=f.ERROR,o.error=V,U(V)}},l.onerror=()=>{const g="An error occurred during the upload.";console.error(g),o.uploadState=f.ERROR,o.error=new Error(g),U(o.error)},l.onloadend=()=>{k("item-upload-end",o,l)},l.send(a)}).catch(u=>(k("item-upload-fail",o,u),Promise.reject(u)))}const W=e.computed(()=>(c.value==null||v.value.length<Number(c.value))&&!ee.value),Z=e.computed(()=>v.value.filter(a=>a.uploadState===f.UPLOADING).length>0),J=e.computed(()=>(Array.isArray(i.value)?i.value:i.value.split(",")).map(o=>o.trim()).filter(o=>o.length>0).map(o=>o.indexOf("/")===-1&&o[0]==="."?o.substr(1):o)),ee=e.computed(()=>m.value||R.value);e.watch(v,o=>{o.map(a=>{a.key=a.key||L()}),k("change",v)},{deep:!0}),e.watch(Z,o=>{k(o?"uploading":"uploaded")});const Me=e.computed(()=>v.value.reduce((o,a)=>(a.file&&(o+=a.file.size),o),0));return{id:s,accept:i,maxFiles:c,maxConcurrent:S,maxItemSize:E,disabled:m,readonly:R,uploadUrl:p,items:v,eventBus:C,canUpload:W,isUploading:Z,acceptedTypes:J,isReadonly:ee,totalSize:Me,emits:k,on:ze,openFileSelector:Ce,addFile:H,addItem:X,createItem:Q,deleteItem:Ae,uploadStart:Be,stopItemUpload:Pe,isImageItem:A,isImage:B,checkFile:M,uploadFile:Y,enqueueUploadFile:_}}const me={class:"vue-drag-uploader__wrapper vue-drag-uploader__items"},fe=e.defineComponent({__name:"MultiUploader",props:e.mergeModels({id:{},uploadUrl:{},placeholder:{},instance:{},options:{default:()=>({})}},{modelValue:{default:()=>[]},modelModifiers:{}}),emits:e.mergeModels(["update:modelValue","change","delete-item","uploading","uploaded","create-item","item-upload-start","item-upload-success","item-upload-fail","item-upload-end","item-upload-progress","invalid-file-type"],["update:modelValue"]),setup(t,{expose:r,emit:n}){const s=t,i=n,c=e.useModel(t,"modelValue"),S=e.ref(c.value);e.watch(c,()=>{S.value=c.value},{deep:!0});const E=e.useTemplateRef("uploader");s.options.dropzone=s.options.dropzone??E;const m=s.instance??T(S,s.uploadUrl??"",s.options),{isReadonly:R,items:p}=m;e.watch(p,()=>{c.value=p.value},{deep:!0});const d=[];for(const h in P){const N=m.on(h,(...z)=>{i(h,...z)});d.push(N)}return e.onUnmounted(()=>{d.forEach(h=>h())}),r({instance:m}),(h,N)=>(e.openBlock(),e.createElementBlock("div",{ref:"uploader",class:e.normalizeClass(["vue-drag-uploader",{"vue-drag-uploader--readonly":e.unref(R)}])},[e.renderSlot(h.$slots,"start",{items:e.unref(p),options:t.options,instance:e.reactive(e.unref(m))}),e.createElementVNode("div",me,[e.renderSlot(h.$slots,"items",{items:e.unref(p),options:t.options,instance:e.reactive(e.unref(m))})]),e.renderSlot(h.$slots,"end",{items:e.unref(p),options:t.options,instance:e.reactive(e.unref(m))})],2))}}),he={key:1,class:"preview-img__body d-flex flex-column justify-content-center align-items-center gap-2"},ge={style:{width:"calc(var(--vmu-img-size) / 3)",height:"calc(var(--vmu-img-size) / 3)"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 384 512"},ye={style:{"word-break":"break-word"}},Ee={class:"preview-img__overlay"},we={style:{width:"1rem",height:"1rem",fill:"white"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},ve={key:2,class:"preview-img__progress"},Se={class:"error-message__message"},ke=e.defineComponent({__name:"ItemCard",props:{item:{},i:{},size:{default:"150px"},isReadonly:{type:Boolean}},emits:["delete","item-click"],setup(t,{emit:r}){const n=t,s=r,i=e.computed(()=>n.item.uploadState),c=e.computed(()=>n.item.progress);function S(){n.isReadonly||s("delete",n.item)}const E=e.computed(()=>n.item.file?n.item.file.name:n.item.title?n.item.title:n.item.url.split("/").pop()),m=e.computed(()=>A(n.item));function R(p){s("item-click",n.item,n.i,p)}return(p,d)=>(e.openBlock(),e.createElementBlock("div",{class:"vue-drag-uploader-item preview-img",style:e.normalizeStyle({"--vmu-img-size":t.size}),onClick:R},[e.renderSlot(p.$slots,"it",{item:t.item},()=>{var h;return[m.value?(e.openBlock(),e.createElementBlock("div",{key:0,class:"preview-img__body",style:e.normalizeStyle({"background-image":"url("+(t.item.thumbUrl||t.item.url)+")",opacity:i.value===e.unref(f).UPLOADED?1:.5})},null,4)):e.createCommentVNode("",!0),m.value?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",he,[e.createElementVNode("div",null,[e.renderSlot(p.$slots,"icon",{item:t.item},()=>[(e.openBlock(),e.createElementBlock("svg",ge,[...d[2]||(d[2]=[e.createElementVNode("path",{d:"M320 464c8.8 0 16-7.2 16-16l0-288-80 0c-17.7 0-32-14.3-32-32l0-80L64 48c-8.8 0-16 7.2-16 16l0 384c0 8.8 7.2 16 16 16l256 0zM0 64C0 28.7 28.7 0 64 0L229.5 0c17 0 33.3 6.7 45.3 18.7l90.5 90.5c12 12 18.7 28.3 18.7 45.3L384 448c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 64z"},null,-1)])]))])]),e.createElementVNode("div",ye,e.toDisplayString(E.value),1)])),e.createElementVNode("div",Ee,[t.isReadonly?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("span",{key:0,class:"preview-img__remove-icon",onClick:d[0]||(d[0]=e.withModifiers(N=>S(),["prevent","stop"]))},[e.renderSlot(p.$slots,"remove-icon",{},()=>[(e.openBlock(),e.createElementBlock("svg",we,[...d[3]||(d[3]=[e.createElementVNode("path",{d:"M135.2 17.7L128 32 32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l384 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0-7.2-14.3C307.4 6.8 296.3 0 284.2 0L163.8 0c-12.1 0-23.2 6.8-28.6 17.7zM416 128L32 128 53.2 467c1.6 25.3 22.6 45 47.9 45l245.8 0c25.3 0 46.3-19.7 47.9-45L416 128z"},null,-1)])]))])])),e.renderSlot(p.$slots,"extra",{item:t.item})]),i.value===e.unref(f).UPLOADING?(e.openBlock(),e.createElementBlock("div",ve,[e.createElementVNode("div",{class:"preview-img__progress-bar",style:e.normalizeStyle({width:c.value*100+"%"})},null,4)])):e.createCommentVNode("",!0),i.value===e.unref(f).ERROR?(e.openBlock(),e.createElementBlock("div",{key:3,class:"preview-img__error-message error-message",onClick:d[1]||(d[1]=e.withModifiers(()=>{},["stop","prevent"]))},[d[4]||(d[4]=e.createElementVNode("span",{class:"error-message__notice"},"Upload fail",-1)),e.createElementVNode("span",Se,e.toDisplayString((h=t.item.error)==null?void 0:h.message),1)])):e.createCommentVNode("",!0)]})],4))}}),be={class:"add-button__body"},Ie={class:"add-button__icon"},Re={style:{width:"32px"},xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Ne={class:"add-button__text"},Le=e.defineComponent({__name:"ItemCardPlaceholder",props:{size:{default:"150px"},text:{default:""}},setup(t){return(r,n)=>(e.openBlock(),e.createElementBlock("div",{class:"vue-drag-uploader-item add-button",key:"empty",style:e.normalizeStyle({"--vmu-img-size":t.size})},[e.createElementVNode("div",be,[e.renderSlot(r.$slots,"default",{},()=>[e.createElementVNode("div",Ie,[e.renderSlot(r.$slots,"icon",e.normalizeProps(e.guardReactiveProps({size:t.size})),()=>[(e.openBlock(),e.createElementBlock("svg",Re,[...n[0]||(n[0]=[e.createElementVNode("path",{d:"M288 109.3L288 352c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-242.7-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352l128 0c0 35.3 28.7 64 64 64s64-28.7 64-64l128 0c35.3 0 64 28.7 64 64l0 32c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64l0-32c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"},null,-1)])]))])]),e.createElementVNode("div",Ne,e.toDisplayString(t.text),1)])])],4))}});w.ItemCard=ke,w.ItemCardPlaceholder=Le,w.MultiUploader=fe,w.UploadState=f,w.createItem=pe,w.handleEvents=O,w.uploaderEvents=P,w.useMultiUploader=T,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
